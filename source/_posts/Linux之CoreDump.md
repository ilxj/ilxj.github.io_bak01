---
title: Linux之CoreDump
date: 2017-06-06 20:21:11
tags: [Linux,工具]
---

## Core Dump 定位

- - -
### 打开CoreDump 功能

- 在终端中输入命令 ulimit -c ，输出的结果为 0，说明默认是关闭 core dump 的，即当程序异常终止时，也不会生成 core dump 文件。
- 我们可以使用命令 ulimit -c unlimited 来开启 core dump 功能，并且不限制 core dump 文件的大小； 如果需要限制文件的大小，将 unlimited 改成你想生成 core 文件最大的大小，注意单位为 blocks（KB）。
- 用上面命令只会对当前的终端环境有效，如果想需要永久生效，可以修改文件 /etc/security/limits.conf
文件，关于此文件的设置参看 **[这里](http://manpages.ubuntu.com/manpages/hardy/man5/limits.conf.5.html)** 。增加一行:

<!--more-->

```
# /etc/security/limits.conf
#
#Each line describes a limit for a user in the form:
#
#<domain>   <type>   <item>   <value>
  *          soft     core   unlimited
```

###  **修改 core 文件保存的路径**

默认生成的 core 文件保存在可执行文件所在的目录下，文件名就为 core。
通过修改 /proc/sys/kernel/core_uses_pid 文件可以让生成 core 文件名是否自动加上 pid 号。
例如 echo 1 > /proc/sys/kernel/core_uses_pid，生成的 core 文件名将会变成 core.pid，其中 pid 表示该进程的 PID。
还可以通过修改 /proc/sys/kernel/core_pattern来控制生成 core 文件保存的位置以及文件名格式。例如可以用 echo "/tmp/corefile-%e-%p-%t" > /proc/sys/kernel/core_pattern 设置生成的 core 文件保存在 “/tmp/corefile” 目录下，文件名格式为 “core-命令名-pid-时间戳”。**[这里](http://man7.org/linux/man-pages/man5/core.5.html)** 有更多详细的说明！

### 实用GDB 定位Core

- 用gcc -g 编译生成带调试信息文件:

```
gcc -g demo.c  -o demo
```

- 运行程序，产生core 文件:

```
./demo
```

- 实用GDB 调试:

```
gdb demo core
```

### 实际例子如下

```
#include <stdarg.h>
#include <stdio.h>
#include <string.h>
// void demoFun( char *start,... )
// {
//     va_list arg_ptr;
//     char *value =NULL;
//     char *valueOne=NULL;
//     value = start;

//     va_start(arg_ptr, start );
//     do{
//         printf("value :%s len=%d \n", value,strlen(value) );
//         valueOne = value;
//         value=va_arg(arg_ptr, int);
//     }while( value!=NULL);
//     va_end(arg_ptr);
//     printf( "%s %d value=%s\n",__FUNCTION__,__LINE__,valueOne );
//     return;
// }

void printfData( int *pData )
{
    *pData = 100;
}
void main( void )
{
    int *null_ptr = NULL;
    printfData( null_ptr );

    return ;
}
```

运行步骤如下

```
alex@alex-virtual-machine:/mnt/hgfs/gagent/working/demo$ gcc -g demo.c  -o demo
alex@alex-virtual-machine:/mnt/hgfs/gagent/working/demo$ ./demo
Segmentation fault (core dumped)
alex@alex-virtual-machine:/mnt/hgfs/gagent/working/demo$ gdb demo core
GNU gdb (Ubuntu/Linaro 7.4-2012.04-0ubuntu2.1) 7.4-2012.04
Copyright (C) 2012 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "i686-linux-gnu".
For bug reporting instructions, please see:
<http://bugs.launchpad.net/gdb-linaro/>...
Reading symbols from /mnt/hgfs/gagent/working/demo/demo...done.

warning: core file may not match specified executable file.
[New LWP 8867]

warning: Can't read pathname for load map: Input/output error.
Core was generated by `./demo.c'.
Program terminated with signal 11, Segmentation fault.
#0  0x080483ba in printfData (pData=0x0) at demo.c:24
24      *pData = 100;
(gdb) where   #----------------->显示在哪个函数发生错误，以及在哪个地方调用了该函数
#0  0x080483ba in printfData (pData=0x0) at demo.c:24
#1  0x080483da in main () at demo.c:29
(gdb) quit    #----------------->退出gdb
```